<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>高崎商科大学 AR案内（カメラ⇔サポート写真 入れ替え版）</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  html,body { height:100%; margin:0; background:#000; color:#fff; font-family:system-ui,-apple-system,Roboto,"Helvetica Neue",Arial; }

  /* ★背景をサポート写真に変更 */
  #supportBackground {
    position:fixed;
    inset:0;
    width:100vw;
    height:100vh;
    object-fit:cover;
    z-index:0;
    background:#000;
  }

  /* ★右上の小窓にカメラ映像を表示 */
  #cameraMini {
    position:fixed;
    top:10px;
    right:10px;
    width:180px;
    height:120px;
    border:2px solid #fff;
    border-radius:10px;
    object-fit:cover;
    z-index:20;
    background:#000;
  }

  #ui { position:fixed; top:8px; left:8px; z-index:15; display:flex; gap:8px; align-items:center; }
  #routeSelect { font-size:16px; padding:6px; }

  #similarityBarContainer { position:fixed; top:140px; right:12px; width:160px; height:14px; background:#222; border-radius:8px; z-index:20; overflow:hidden; }
  #similarityBar { width:0%; height:100%; background:red; transition:width 220ms linear, background 120ms; }

  #arrowOverlay { position:fixed; bottom:160px; left:50%; transform:translateX(-50%); width:140px; z-index:15; display:none; }
  #textOverlay { position:fixed; bottom:36px; left:0; right:0; text-align:center; font-size:20px; text-shadow:0 0 8px #000; z-index:15; }

  canvas.hidden { display:none; visibility:hidden; position:fixed; width:1px; height:1px; left:-9999px; top:-9999px; }
</style>

<!-- OpenCV.js -->
<script>
  function onOpenCvReady() {
    console.log("OpenCV ready");
    window._cvReady = true;
  }
</script>
<script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady()"></script>
</head>
<body>

  <!-- ★背景にサポート画像を表示する要素 -->
  <img id="supportBackground" src="" alt="background">

  <!-- ★右上にカメラ映像 -->
  <video id="cameraMini" autoplay playsinline muted></video>

  <!-- UI -->
  <div id="ui">
    <select id="routeSelect">
      <option value="route_office">正門 → 事務室</option>
      <option value="route_library">正門 → 図書館</option>
      <option value="route_cafe">正門 → カフェ</option>
      <option value="route_career">正門 → キャリアサポートセンター</option>
    </select>
  </div>

  <div id="similarityBarContainer"><div id="similarityBar"></div></div>

  <img id="arrowOverlay" src="arrow_forward.jpg" alt="arrow">
  <div id="textOverlay">読み込み中…</div>

  <canvas id="videoCanvas" class="hidden"></canvas>
  <canvas id="imgCanvas" class="hidden"></canvas>

<script>
/* ===================
   設定
=================== */
const ROUTES = {
  route_office: [
    { text:"正門を出発", image:"support/gate.jpg", arrow:"arrow/go.jpg" },
    { text:"直進してください", image:"support/niwa.jpg", arrow:"arrow/tyokusinn.jpg" },
    { text:"左折してください", image:"support/1gou.jpg", arrow:"arrow/sasetu.jpg" },
    { text:"事務室前に到着", image:"support/office.jpg", arrow:"arrow/stop.jpg" }
  ],
  route_library: [
    { text:"正門を出発", image:"support/gate.jpg", arrow:"arrow/go.jpg" },
    { text:"右折してください", image:"support/niwa.jpg", arrow:"arrow/usetu.jpg" },
    { text:"直進してください", image:"support/2gou.jpg", arrow:"arrow/tyokusinn.jpg" },
    { text:"図書館前に到着", image:"support/library.jpg", arrow:"arrow/stop.jpg" }
  ],
  route_cafe: [
    { text:"正門を出発", image:"support/gate.jpg", arrow:"arrow/go.jpg" },
    { text:"直進してください", image:"support/niwa.jpg", arrow:"arrow/tyokusinn.jpg" },
    { text:"直進してください", image:"support/1gou.jpg", arrow:"arrow/tyokusinn.jpg" },
    { text:"右折してください", image:"support/3gou.jpg", arrow:"arrow/usetu.jpg" },
    { text:"カフェ前に到着", image:"support/cafe.jpg", arrow:"arrow/stop.jpg" }
  ],
  route_career: [
    { text:"正門を出発", image:"support/gate.jpg", arrow:"arrow/go.jpg" },
    { text:"直進してください", image:"support/niwa.jpg", arrow:"arrow/tyokusinn.jpg" },
    { text:"直進してください", image:"support/1gou.jpg", arrow:"arrow/tyokusinn.jpg" },
    { text:"右折してください", image:"support/3gou.jpg", arrow:"arrow/usetu.jpg" },
    { text:"左折してください", image:"support/cafe.jpg", arrow:"arrow/sasetu.jpg" },
    { text:"キャリアサポートセンター前に到着", image:"support/career.jpg", arrow:"arrow/stop.jpg" }
  ]
};

const MATCH_GOOD_DISTANCE = 60;
const MATCH_RATIO = 0.75;
const SIMILARITY_AUTO_ADV = 70;

/* ===================
   状態
=================== */
let currentRouteKey = document.getElementById('routeSelect').value;
let currentRoute = ROUTES[currentRouteKey];
let currentStepIndex = 0;

let supportMats = {};
let supportLoaded = {};

let video = document.getElementById('cameraMini');  // ★変更：ミニ画面をカメラ映像に使用
let videoCanvas = document.getElementById('videoCanvas');
let imgCanvas = document.getElementById('imgCanvas');
let videoCtx = videoCanvas.getContext('2d');
let imgCtx = imgCanvas.getContext('2d');

let smoothingSimilarity = 0;
let autoAdvanceLock = false;

function setStatus(text){ document.getElementById('textOverlay').textContent = text; }

/* ★サポート画像 → 背景として設定 */
function setSupportBackground(src){
  document.getElementById('supportBackground').src = src;
}

function setArrow(src){
  const a=document.getElementById('arrowOverlay');
  a.src = src;
}

/* ===================
   以下は元コードと同じ（処理ロジックは変更なし）
=================== */

/* ------ support preload ------ */
async function preloadAllSupportMats() {
  for(const key of Object.keys(ROUTES)) {
    supportMats[key] = [];
    supportLoaded[key] = false;
    const steps = ROUTES[key];
    for(const step of steps){
      await new Promise((resolve)=>{
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.src = step.image;
        img.onload = () => {
          const W = 320, H = 240;
          imgCanvas.width = W; imgCanvas.height = H;
          imgCtx.drawImage(img,0,0,W,H);
          try{
            let mat = cv.imread(imgCanvas);
            cv.cvtColor(mat, mat, cv.COLOR_RGBA2GRAY);
            supportMats[key].push(mat);
          }catch(e){
            console.error("cv.imread support image failed:", e);
            supportMats[key].push(null);
          }
          resolve();
        };
        img.onerror = (e)=>{ supportMats[key].push(null); resolve(); };
      });
    }
    supportLoaded[key] = true;
  }
}

/* ------ camera ------ */
async function startCamera() {
  try{
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    video.srcObject = stream;
    await new Promise(r => video.onloadedmetadata = r);

    videoCanvas.width = 640;
    videoCanvas.height = Math.round(video.videoHeight * (640/video.videoWidth));

    imgCanvas.width = 320;
    imgCanvas.height = 240;

    return true;
  }catch(err){
    setStatus("カメラを許可してください: " + err.message);
    return false;
  }
}

/* ------ step UI ------ */
function showStep(){
  const step = currentRoute[currentStepIndex];
  setSupportBackground(step.image);   // ★背景に表示
  setArrow(step.arrow);
  setStatus(step.text);
  updateSimilarityBar(0);
  smoothingSimilarity = 0;
}

/* ------ bar ------ */
function updateSimilarityBar(rawPct){
  const alpha = 0.35;
  smoothingSimilarity = smoothingSimilarity*(1-alpha)+rawPct*alpha;
  const pct = Math.max(0, Math.min(100, smoothingSimilarity));
  const bar = document.getElementById('similarityBar');
  bar.style.width = pct + "%";
  if(pct < 30) bar.style.background = "red";
  else if(pct >= SIMILARITY_AUTO_ADV) bar.style.background = "green";
  else bar.style.background = "yellow";
  return pct;
}

/* ------ ORB matching（元と同じ） ------ */
function computeSimilarityORB() {
  if(!video.videoWidth) return 0;
  if(!supportLoaded[currentRouteKey]) return 0;
  const supportMat = supportMats[currentRouteKey][currentStepIndex];
  if(!supportMat) return 0;

  videoCtx.drawImage(video, 0, 0, videoCanvas.width, videoCanvas.height);

  let src=null, gray=null;
  try{
    src = cv.imread(videoCanvas);
    gray = new cv.Mat();
    cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
  }catch(e){
    if(src) src.delete();
    if(gray) gray.delete();
    return 0;
  }

  let frameSmall = new cv.Mat();
  cv.resize(gray, frameSmall, new cv.Size(320,240));

  let orb=new cv.ORB();

  let kp1 = new cv.KeyPointVector();
  let kp2 = new cv.KeyPointVector();
  let des1 = new cv.Mat();
  let des2 = new cv.Mat();

  orb.detectAndCompute(frameSmall, new cv.Mat(), kp1, des1);
  orb.detectAndCompute(supportMat, new cv.Mat(), kp2, des2);

  let goodMatches=0;
  let kp2count=Math.max(1,kp2.size());

  if(!des1.empty() && !des2.empty()){
    try{
      let bf=new cv.BFMatcher(cv.NORM_HAMMING,false);
      let matches=new cv.DMatchVectorVector();
      bf.knnMatch(des1, des2, matches, 2);

      for(let i=0;i<matches.size();i++){
        let mv = matches.get(i);
        if(mv.size() < 2){ mv.delete(); continue; }
        let m=mv.get(0), n=mv.get(1);
        if(m.distance < MATCH_RATIO*n.distance && m.distance <= MATCH_GOOD_DISTANCE){
          goodMatches++;
        }
        mv.delete();
      }
      matches.delete();
      bf.delete();
    }catch(e){}
  }

  const target=Math.max(10, Math.floor(kp2count*0.12));
  let similarity=Math.min(100,(goodMatches/target)*100);

  src.delete(); gray.delete(); frameSmall.delete();
  des1.delete(); des2.delete(); kp1.delete(); kp2.delete();
  orb.delete();

  return similarity;
}

/* ------ auto advance ------ */
function tryAutoAdvance(similarity){
  const pct = updateSimilarityBar(similarity);
  if(pct >= SIMILARITY_AUTO_ADV && !autoAdvanceLock){
    autoAdvanceLock=true;
    setTimeout(()=>{
      if(currentStepIndex < currentRoute.length-1){
        currentStepIndex++;
        showStep();
      }else{
        setStatus("目的地に到着しました");
      }
      setTimeout(()=>{ updateSimilarityBar(0); autoAdvanceLock=false; },300);
    },500);
  }
}

/* ------ loop ------ */
function startProcessingLoop(){
  function loop(){
    if(!video.videoWidth){
      requestAnimationFrame(loop);
      return;
    }
    const sim = computeSimilarityORB();
    tryAutoAdvance(sim);
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);
}

/* ------ init ------ */
async function initAR(){
  if(!window._cvReady){
    await new Promise(r=>{
      const chk=()=>{ if(window._cvReady) r(); else setTimeout(chk,100); };
      chk();
    });
  }
  await startCamera();
  await preloadAllSupportMats();

  showStep();
  startProcessingLoop();
}

document.getElementById('routeSelect').addEventListener('change',()=>{
  currentRouteKey=document.getElementById('routeSelect').value;
  currentRoute=ROUTES[currentRouteKey];
  currentStepIndex=0;
  showStep();
});

window.addEventListener('load',()=>{ initAR(); });

</script>
</body>
</html>
