<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AR案内・類似度バー付き完成形</title>
  <style>
    body, html { margin: 0; padding: 0; overflow: hidden; background: #000; font-family: sans-serif; color: white; }
    #cameraView { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; object-fit: cover; z-index: 1; }

    #routeSelectBox {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.6);
      padding: 10px;
      border-radius: 8px;
      z-index: 20;
    }
    #routeSelect {
      font-size: 16px;
      padding: 6px;
    }

    #backBtn {
      margin-top: 6px;
      width: 100%;
      padding: 6px;
      border: none;
      border-radius: 6px;
      background: #444;
      color: white;
      font-size: 14px;
    }

    #guideBox { position: fixed; bottom: 0; width: 100%; background: rgba(0,0,0,0.55); padding: 14px; font-size: 20px; text-align: center; z-index: 10; }
    #supportArea { position: fixed; right: 10px; top: 80px; width: 160px; background: rgba(0,0,0,0.5); padding: 8px; border-radius: 8px; z-index: 20; text-align: center; }
    #supportImg { width: 100%; border-radius: 6px; }
    #simText { font-size: 12px; margin-top: 4px; }
    #simBarBase { width: 100%; height: 6px; background: #444; border-radius: 5px; margin-top: 4px; }
    #simBarFill { width: 0%; height: 100%; background: #00ff99; border-radius: 5px; }
    #stepInfo { font-size: 12px; opacity: 0.9; margin-top: 6px; }
  </style>
</head>
<body>
  <video id="cameraView" autoplay playsinline></video>

  <div id="routeSelectBox">
    <select id="routeSelect">
      <option value="0">在来線7番線 → 上信電鉄</option>
      <option value="1">西口 → 在来線4番線</option>
    </select>
    <button id="backBtn">◀ 戻る</button>
  </div>

  <div id="supportArea">
    <img id="supportImg" src="step1.jpg" />
    <div id="simText">一致度: 0%</div>
    <div id="simBarBase"><div id="simBarFill"></div></div>
    <div id="stepInfo">この場所付近に来たらクリック</div>
  </div>

  <div id="guideBox">案内を読み込み中...</div>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0"></script>

  <script>
    const guideBox = document.getElementById("guideBox");
    const supportImg = document.getElementById("supportImg");
    const simText = document.getElementById("simText");
    const simBarFill = document.getElementById("simBarFill");
    const video = document.getElementById("cameraView");
    const routeSelect = document.getElementById("routeSelect");
    const backBtn = document.getElementById("backBtn");

    let model;
    let step = 0;

    const routes = [
      { name: "在来線7番線 → 上信電鉄", steps: [ { text: "7番線を出る", img: "step1.jpg" }, { text: "通路を直進", img: "step2.jpg" }, { text: "上信電鉄入口へ", img: "step3.jpg" } ] },
      { name: "西口 → 在来線4番線", steps: [ { text: "西口から直進", img: "step4.jpg" }, { text: "分岐点を右へ", img: "step5.jpg" }, { text: "4番線ホームへ", img: "step6.jpg" } ] }
    ];

    let currentRoute = 0;

    async function startCamera() {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
      video.srcObject = stream;
    }

    function updateStep() {
      const s = routes[currentRoute].steps[step];
      guideBox.textContent = s.text;
      supportImg.src = s.img;
    }

    async function compare() {
      if (!model) return;
      const camTensor = tf.browser.fromPixels(video).resizeBilinear([224,224]).toFloat().expandDims();
      const supportImageElement = new Image(); supportImageElement.src = supportImg.src;
      await new Promise(res => supportImageElement.onload = res);
      const supTensor = tf.browser.fromPixels(supportImageElement).resizeBilinear([224,224]).toFloat().expandDims();
      const camFeat = model.infer(camTensor);
      const supFeat = model.infer(supTensor);
      const sim = tf.losses.cosineDistance(camFeat, supFeat, 1).dataSync()[0];
      const similarity = Math.max(0, 1 - sim);
      const percent = Math.round(similarity * 100);
      simText.textContent = `一致度: ${percent}%`;
      simBarFill.style.width = `${percent}%`;
      if (percent >= 50) nextStep();
    }

    function nextStep() {
      step++;
      if (step >= routes[currentRoute].steps.length) { guideBox.textContent = "案内終了"; return; }
      updateStep();
    }

    function prevStep() {
      if (step > 0) step--;
      updateStep();
    }

    document.body.addEventListener("click", nextStep);

    routeSelect.addEventListener("change", () => {
      currentRoute = parseInt(routeSelect.value);
      step = 0;
      updateStep();
    });

    backBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      prevStep();
    });

    async function init() {
      await startCamera();
      model = await mobilenet.load();
      updateStep();
      setInterval(compare, 1500);
    }

    init();
  </script>
</body>
</html>
